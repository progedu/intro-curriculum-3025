"use strict";var pug=require("pug"),Cookies=require("cookies"),util=require("./handler-util"),Post=require("./post"),trackingIdKey="tracking_id";function handle(t,n){var o=new Cookies(t,n);switch(addTrackingCookie(o),t.method){case"GET":n.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),Post.findAll({order:[["id","DESC"]]}).then(function(e){e.forEach(function(e){e.content=e.content.replace(/\n/g,"<br>")}),n.end(pug.renderFile("./views/posts.pug",{posts:e,user:t.user})),console.info("閲覧されました: user: ".concat(t.user,", ")+"trackinId: ".concat(o.get(trackingIdKey),",")+"remoteAddress: ".concat(t.connection.remoteAddress,", ")+"userAgent: ".concat(t.headers["user-agent"]," "))});break;case"POST":var r=[];t.on("data",function(e){r.push(e)}).on("end",function(){r=Buffer.concat(r).toString();var e=decodeURIComponent(r).split("content=")[1];console.info("投稿されました: "+e),Post.create({content:e,trackingCookie:o.get(trackingIdKey),postedBy:t.user}).then(function(){handleRedirectPosts(t,n)})});break;default:util.handleBadRequest(t,n)}}function handleDelete(t,n){switch(t.method){case"POST":var o=[];t.on("data",function(e){o.push(e)}).on("end",function(){o=Buffer.concat(o).toString();var e=decodeURIComponent(o).split("id=")[1];Post.findByPk(e).then(function(e){t.user!==e.postedBy&&"admin"!==t.user||e.destroy().then(function(){console.info("削除されました: user: ".concat(t.user,", ")+"remoteAddress: ".concat(t.connection.remoteAddress,", ")+"userAgent: ".concat(t.headers["user-agent"]," ")),handleRedirectPosts(t,n)})})});break;default:util.handleBadRequest(t,n)}}function addTrackingCookie(e){var t,n;e.get(trackingIdKey)||(t=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),n=new Date((new Date).getTime()+864e5),e.set(trackingIdKey,t,{expires:n}))}function handleRedirectPosts(e,t){t.writeHead(303,{Location:"/posts"}),t.end()}module.exports={handle:handle,handleDelete:handleDelete};